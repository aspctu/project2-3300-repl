<html>

<head>
  <title>3300 Project 2</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>

  <style>
    path.country-outline {
      stroke: #999;
      stroke-width: 1;
    }

    #controls {
      display: flex;
      flex-direction: row;
      justify-content: center;
    }

    #category-controls {
      width: fit-content;
    }

    #category-controls p {
      margin: 3px;
    }

    #category-controls p.category {
      border-radius: 20px;
      padding: 2px 5px;
      margin: 2px 0px;
      width: 150px;
    }
  </style>
</head>

<body>
  <svg id="map1" height="600" width="1000" style="margin:20px"></svg>
  <div id="controls">
    <div id="category-controls">
      <p>Degree of endangerment:</p>
    </div>
  </div>

  <script>
    const map1 = d3.select("svg#map1");
    const controls = d3.select("#controls");
    const chart = map1.append("g");

    const height = map1.attr("height");
    const width = map1.attr("width");

    async function requestData() {
      // dataset without Antarctica
      const mapData = await d3.json("countries-110m.json");

      const countries = topojson.feature(mapData, mapData.objects.countries1);
      const countriesMesh = topojson.mesh(mapData, mapData.objects.countries1);

      const proj = d3.geoNaturalEarth1().fitSize([width, height], countries);
      const path = d3.geoPath().projection(proj);

      chart.selectAll("path.country").data(countries.features)
        .join("path")
        .attr("class", "country")
        .attr("fill", "#eee")
        .attr("d", path)

      chart.append("path").datum(countriesMesh)
        .attr("class", "country-outline")
        .attr("d", path)
        .attr("fill", "none");

      const languages = await d3.csv("endangered-languages.csv");
      console.log(languages);

      const categories = [...new Set(languages.map(d => d["Degree of endangerment"]))];

      const colorScale = d3.scaleOrdinal()
        .domain(categories)
        .range(["#facb32", "#db820d", "#bf5900", "#bf0000", "#570000"]);

      languages.forEach(d => {
        d.projCoords = proj([d.Longitude, d.Latitude]);
      });

      chart.selectAll("circle.lang").data(languages)
        .join("circle")
        .attr("class", "lang")
        .attr("r", 2)
        .attr("opacity", 0.7)
        .attr("fill", d => colorScale(d["Degree of endangerment"]))
        .attr("cx", d => d.projCoords[0])
        .attr("cy", d => d.projCoords[1])
        .attr("category", d => d["Degree of endangerment"]);

      const categoryControls = d3.select("#category-controls");

      categories.forEach((s, i) => {
        categoryControls.append("p")
          .text(s)
          .attr("class", "category")
          .style("background-color", colorScale(s))
          .style("color", i > 1 ? "white" : "black")
          .on("mouseover", function () {
            chart.selectAll("circle").each(function () {
              let circle = d3.select(this);
              if (circle.attr("category") === s) {
                circle.attr("visibility", "")
              } else {
                circle.attr("visibility", "hidden");
              }
            });
          });
      });

      categoryControls.append("p")
        .text("All")
        .attr("class", "category")
        .style("background-color", "black")
        .style("color", "white")
        .on("mouseover", function () {
          chart.selectAll("circle").each(function () {
            d3.select(this).attr("visibility", "");
          });
        });
    }

    requestData();
  </script>
</body>

</html>